<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Hamilton Weather</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Dosis:400,700" rel="stylesheet" />
    <link href="style.css" rel="stylesheet" />

</head>

<body onload="init();">


    <div class="container">

        <div class="card">
            <div class="card-header bg-info">
                <h2>Hamilton Weather</h2>
            </div>
            <div class="card-body">
                <h2 id="data"></h2>
                <canvas id="compass" width="200" height="200"></canvas>
            </div>
            <div class="card-footer bg-info">
                <p id="lastUpdate"></p>
            </div>

        </div>
    </div>






    </div>

    <script type="text/javascript">
        var img = null,
            needle = null,
            ctx = null,
            degrees = null;


        var connectGHapi =
            "https://www.connectgh.com.au/api/records/1.0/search/?dataset=weather-station-status&q=&rows=1&sort=time&facet=deviceid&facet=windcompassdirection&facet=location&refine.location=Hamilton";
        var weatherInfo = document.getElementById("data");
        var lastUpdate = document.getElementById("lastUpdate");

        fetch(connectGHapi)
            .then((response) => response.json())
            .then((data) => {
                let info = data.records;
                return info.map((records) => {

                    let airTemp = records.fields.airtemp;
                    let hPa = records.fields.atmosphericpressure;
                    let windSpeed = records.fields.windspeed;
                    let windDir = records.fields.windcompassdirection;


                    degrees = records.fields.winddirection;



                    weatherInfo.innerHTML = `The current temp is: ${records.fields.airtemp}&#8451;`

                    var date = new Date(records.fields.time);
                    lastUpdate.innerHTML = `Last Updated at ${date.toString()}`;

                });
            });




        function clearCanvas() {
            // clear canvas
            ctx.clearRect(0, 0, 200, 200);
        }

        function draw() {

            clearCanvas();

            // Draw the compass onto the canvas
            ctx.drawImage(img, 0, 0);

            // Save the current drawing state
            ctx.save();

            // Now move across and down half the 
            ctx.translate(100, 100);

            // Rotate around this point
            ctx.rotate(degrees * (Math.PI / 180));

            // Draw the image back and up
            ctx.drawImage(needle, -100, -100);

            // Restore the previous drawing state
            ctx.restore();

            // Increment the angle of the needle by 5 degrees
            //degrees += 5;
        }

        function imgLoaded() {
            // Image loaded event complete.  Start the timer
            setInterval(draw, 100);
        }

        function init() {
            // Grab the compass element
            var canvas = document.getElementById('compass');

            // Canvas supported?
            if (canvas.getContext('2d')) {
                ctx = canvas.getContext('2d');

                // Load the needle image
                needle = new Image();
                needle.src = 'needle.png';

                // Load the compass image
                img = new Image();
                img.src = 'compass.png';
                img.onload = imgLoaded;
            } else {
                alert("Canvas not supported!");
            }
        }


        var map;
        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -34.397, lng: 150.644 },
                zoom: 8
            });
        }
    </script>


</body>

</html>